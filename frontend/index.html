<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>GeoLocate MVP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- JSZip для предпросмотра ZIP -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <style>
:root{
  --bg:#f6f7fb; --surface:#fff; --text:#111827; --subtext:#6b7280; --border:#e5e7eb;
  --accent:#2563eb; --accent-2:#1e40af; --accent-3:#3b82f6;
  --ok:#16a34a; --warn:#d97706; --danger:#dc2626;
  --shadow:0 10px 30px rgba(2,6,23,.08),0 2px 8px rgba(2,6,23,.06);
  --radius:14px;
}
@media (prefers-color-scheme: dark){
  :root{ --bg:#0b1220; --surface:#0f172a; --text:#e5e7eb; --subtext:#9ca3af; --border:#1f2937;
    --accent:#60a5fa; --accent-2:#3b82f6; --accent-3:#93c5fd;
    --shadow:0 10px 30px rgba(0,0,0,.35),0 2px 8px rgba(0,0,0,.25);
  }
}
html,body{height:100%}
body{
  margin:16px;
  background:
    radial-gradient(1200px 600px at -10% -20%, rgba(37,99,235,.10), transparent 60%),
    radial-gradient(1000px 500px at 120% 0%, rgba(99,102,241,.10), transparent 60%),
    var(--bg);
  color:var(--text);
  font:14px/1.45 system-ui, Segoe UI, Roboto, Arial, sans-serif;
}
header{
  display:flex; gap:12px; align-items:center; padding:10px 12px;
  background:linear-gradient(135deg, rgba(37,99,235,.10), rgba(99,102,241,.10));
  border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow);
  margin-bottom:16px;
}
#authStatus{font-weight:600}
#logoutBtn{margin-left:auto}
.row{display:flex; gap:16px; flex-wrap:wrap;}
.spacer{flex:1}

.card{
  background:var(--surface); border:1px solid var(--border);
  border-radius:var(--radius); padding:14px; box-shadow:var(--shadow);
  min-width:320px;
}
.card h3{margin:0 0 8px 0; font-size:16px}

label{display:block; margin-top:8px; color:var(--subtext)}
input[type="text"], input[type="password"], input[type="number"], select, input[type="date"]{
  width:240px; padding:10px 12px; color:var(--text); background:transparent;
  border:1px solid var(--border); border-radius:10px; outline:none;
  transition: box-shadow .15s, border-color .15s, background-color .2s ease;
}
input::placeholder{color:#9aa3b2}
input:focus, select:focus{
  border-color:var(--accent);
  box-shadow:0 0 0 3px color-mix(in srgb, var(--accent) 25%, transparent);
}

button{
  appearance:none; border:1px solid var(--accent);
  background:linear-gradient(180deg, var(--accent), var(--accent-2));
  color:#fff; font-weight:600; padding:9px 14px; border-radius:10px; cursor:pointer;
  box-shadow:0 6px 16px rgba(37,99,235,.25);
  transition: transform .06s, filter .2s, box-shadow .2s;
}
button:hover{filter:brightness(1.05); box-shadow:0 8px 20px rgba(37,99,235,.35)}
button:active{transform:translateY(1px)}
button[disabled]{opacity:.6; cursor:not-allowed; box-shadow:none}
.btn-secondary{
  border-color:var(--border);
  background:linear-gradient(180deg,#ffffff,#f8fafc);
  color:var(--text);
  box-shadow:0 6px 16px rgba(2,6,23,.08);
}

.pager{display:flex; gap:10px; align-items:center; margin:8px 0; flex-wrap:wrap}
.pager #photos_page_info, .pager #uploads_page_info{color:var(--subtext); font-weight:600}
.pager select{width:auto; padding:8px 10px; border-radius:8px}

/* Гладкая панель фильтров внутри карточек */
.card .toolbar{
  display:flex; flex-wrap:wrap; gap:10px; align-items:end; width:100%; margin:6px 0 10px;
}
.card .toolbar label{margin:0;}
.card .toolbar input[type="date"]{width:auto}

/* таблицы */
table{border-collapse:separate; border-spacing:0; width:100%; background:var(--surface); border:1px solid var(--border); border-radius:12px; overflow:hidden}
th,td{padding:10px 12px; border-bottom:1px solid var(--border); vertical-align:middle}
thead th{background:linear-gradient(180deg,#f8fafc,#eef2ff); color:#334155; text-align:left; font-weight:700}
tbody tr:hover{background:color-mix(in srgb, var(--accent) 8%, transparent)}
tbody tr:last-child td{border-bottom:none}
.ellipsis{white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

/* карта */
#map{width:100%; height:360px; border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow)}

/* превью сетки поиска */
#search_results, #coords_results{
  display:grid; grid-template-columns:repeat(auto-fill, minmax(180px,1fr));
  gap:12px; margin-top:12px;
}
.card-photo{
  border:1px solid var(--border); border-radius:12px; overflow:hidden; box-shadow:var(--shadow);
  background:var(--surface); transition: transform .08s, box-shadow .2s;
}
.card-photo:hover{transform:translateY(-2px); box-shadow:0 14px 30px rgba(2,6,23,.15)}
.card-photo .thumb{display:block; width:100%; height:120px; background:#0b1220}
.card-photo img{width:100%; height:100%; object-fit:cover; display:block}
.card-photo .meta{padding:10px; font:12px/1.45 system-ui,Arial; color:var(--subtext)}
.card-photo .meta .ellipsis{color:var(--text); font-weight:600}

/* статусы */
pre, #reg_out, #login_out, #upload_out, #zip_out, #calc_out, #search_meta, #coords_meta, #export_status{
  background:rgba(2,6,23,.03); border:1px dashed var(--border); padding:10px; border-radius:10px; color:var(--subtext)
}

/* предпросмотр одиночного файла */
.preview-wrap{margin-top:8px; border:1px solid var(--border); border-radius:10px; padding:6px; background:#fafafa; max-width:360px}
#file_preview{display:block; width:100%; height:auto; max-height:280px; object-fit:contain; border-radius:6px}

/* ZIP — компактные миниатюры */
#zip_grid{display:grid; grid-template-columns:repeat(auto-fill, minmax(92px,1fr)); gap:8px}
.zip-thumb{padding:6px; border:1px solid #e5e7eb; border-radius:10px; background:#fff}
.zip-thumb img{width:100%; height:72px; object-fit:cover; display:block; border-radius:6px}
.zip-thumb .meta{margin-top:4px; font-size:11px; line-height:1.2; color:#555; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

/* превью результата расчёта — поменьше */
#calc_preview_thumbs a{max-width:160px}
#calc_preview_thumbs img{width:100%; height:100px; object-fit:cover; display:block; border-radius:6px}

/* Leaflet attribution скрыть */
.leaflet-control-attribution img, .leaflet-control-attribution svg{display:none !important}
.leaflet-control-attribution::before, .leaflet-control-attribution::after{content:none !important; display:none !important}
  </style>
</head>
<body>
  <h1>GeoLocate MVP</h1>

  <header>
    <div id="authStatus">Гость</div>
    <button id="logoutBtn" style="display:none;">Выйти</button>
  </header>

  <div class="row">
    <!-- Регистрация -->
    <div class="card" id="cardRegister" style="display:none;">
      <h3>Регистрация</h3>
      <label>Имя <input id="reg_name" type="text"></label>
      <label>Пароль <input id="reg_pass" type="password"></label>
      <label>Роль
        <select id="reg_role" style="width:240px">
          <option value="viewer" selected>viewer</option>
          <option value="uploader">uploader</option>
          <option value="runner">runner</option>
          <option value="exporter">exporter</option>
          <option value="admin">admin</option>
        </select>
      </label>
      <button id="btnRegister" type="button">Зарегистрировать</button>
      <div id="reg_out"></div>
    </div>

    <!-- Вход -->
    <div class="card">
      <h3>Вход</h3>
      <label>Имя <input id="login_name" type="text" value="admin"></label>
      <label>Пароль <input id="login_pass" type="password" value="admin"></label>
      <button id="btnLogin" type="button">Войти</button>
      <div id="login_out"></div>
    </div>

    <!-- Загрузка -->
    <div class="card" id="cardUpload" style="min-width:420px;">
      <h3>Загрузка</h3>

      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <input id="file" type="file" accept="image/*" style="display:none">
        <button id="btnPickPhoto" type="button">Загрузить фото</button>
        <span id="file_info" style="color:#666;">Фото не выбрано</span>

        <input id="zip" type="file" accept=".zip" style="display:none">
        <button id="btnPickZip" type="button">Загрузить ZIP</button>
        <span id="zip_info" style="color:#666;">ZIP не выбран</span>
      </div>

      <!-- Предпросмотр ZIP -->
      <div id="zip_preview_wrap" style="display:none; margin-top:12px;">
        <div id="zip_parse_status" style="color:#666; margin-bottom:8px;">Читаю ZIP…</div>

        <div class="pager">
          <button id="btnPrevZip" type="button">← Пред</button>
          <span id="zip_page_info">стр. 1</span>
          <button id="btnNextZip" type="button">След →</button>
          <div class="spacer"></div>
          <span id="zip_count_info" style="color:#666;"></span>
        </div>

        <div id="zip_grid"></div>
      </div>

      <!-- Параметры -->
      <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;">
        <input id="shot_lat" type="number" step="any" placeholder="lat">
        <input id="shot_lon" type="number" step="any" placeholder="lon">

        <select id="type" style="width:240px">
          <option value="Мусор">Мусор</option>
          <option value="Стройка">Стройка</option>
        </select>

        <select id="subtype" style="width:240px">
          <option value="ИНС">ИНС</option>
          <option value="КИНС">КИНС</option>
          <option value="Другое">Другое</option>
        </select>
      </div>

      <!-- Превью одиночного файла -->
      <div id="file_preview_wrap" class="preview-wrap" style="display:none;">
        <img id="file_preview" alt="preview">
      </div>

      <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:12px;">
        <button id="btnUpload" type="button">Импорт фото</button>
        <button id="btnUploadZip" type="button">Импорт ZIP</button>
      </div>

      <div id="upload_out" style="margin-top:6px; color:#444;"></div>
      <div id="zip_out" style="margin-top:6px; color:#444;"></div>
    </div>
  </div>

  <!-- Поиск по адресу -->
  <section style="margin-top:20px">
    <h2>Поиск по адресу</h2>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <label for="addr">Адрес:</label>
      <input id="addr" type="text" placeholder="Введите адрес" style="min-width:360px" />
      <button id="btnSearchAddress" type="button">Искать</button>
      <div id="search_meta" style="margin-left:auto;color:#444;"></div>
    </div>
    <div id="map" style="display:none; margin-top:10px"></div>
    <div id="search_results" style="display:none;"></div>
    <pre id="search_out" style="background:#f6f8fa;border:1px solid #eaecef;padding:10px;margin-top:10px;max-height:260px;overflow:auto"></pre>
  </section>

  <!-- Поиск по координатам -->
  <section style="margin-top:20px">
    <h2>Поиск по координатам</h2>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <label>lat: <input id="coord_lat" type="text" placeholder="latitude" style="width:140px"></label>
      <label>lon: <input id="coord_lon" type="text" placeholder="longitude" style="width:140px"></label>
      <label>limit: <input id="coord_limit" type="number" value="12" style="width:80px"></label>
      <button id="btnSearchCoords" type="button">Искать</button>
      <div id="coords_meta" style="margin-left:auto;color:#444;"></div>
    </div>
    <div id="coords_results" style="display:none;"></div>
  </section>

  <hr/>

  <div class="row">
    <!-- Фотографии + фильтры + пагинация -->
    <div class="card" style="min-width:380px; flex:1 1 520px;">
      <h3>Фотографии</h3>

      <!-- ФИЛЬТРЫ ВНУТРИ КАРТОЧКИ -->
      <div class="toolbar">
        <label>Статус координат
          <select id="photos_filter_status" style="width:auto">
            <option value="all" selected>Все</option>
            <option value="with">Есть lat/lon</option>
            <option value="without">Нет lat/lon</option>
          </select>
        </label>
        <label>с <input id="photos_date_from" type="date"></label>
        <label>по <input id="photos_date_to" type="date"></label>
        <button id="btnApplyPhotosFilter" type="button" class="btn-secondary">Применить</button>
      </div>

      <div class="pager">
        <div>
          На странице:
          <select id="photos_page_size">
            <option selected>5</option>
            <option>25</option>
            <option>50</option>
            <option>100</option>
            <option>200</option>
          </select>
        </div>
        <div class="spacer"></div>
        <button id="btnPrevPhotos" type="button">← Пред</button>
        <span id="photos_page_info">стр. 1</span>
        <button id="btnNextPhotos" type="button">След →</button>
        <button id="btnLoadPhotos" type="button" title="Обновить текущую страницу">Обновить</button>
      </div>

      <div id="photos"></div>
    </div>

    <!-- Запуск расчёта координат (admin) -->
    <div class="card" id="cardCalc" style="min-width:420px; display:none;">
      <h3>Запуск расчёта координат</h3>

      <!-- ФИЛЬТРЫ ВНУТРИ КАРТОЧКИ -->
      <div class="toolbar">
        <label>Статус
          <select id="calc_filter_status">
            <option value="all" selected>Все</option>
            <option value="without">Нерасчитанные (нет lat/lon)</option>
            <option value="with">Рассчитанные (есть lat/lon)</option>
          </select>
        </label>
        <label>с <input id="calc_date_from" type="date"></label>
        <label>по <input id="calc_date_to" type="date"></label>
        <button id="btnApplyUploadsFilter" type="button" class="btn-secondary">Применить</button>
      </div>

      <div class="pager">
        <div>На странице: 5</div>
        <div class="spacer"></div>
        <button id="btnPrevUploads" type="button">← Пред</button>
        <span id="uploads_page_info">стр. 1</span>
        <button id="btnNextUploads" type="button">След →</button>
        <button id="btnLoadUploads" type="button" title="Обновить текущую страницу">Обновить</button>
      </div>

      <div id="uploads"></div>

      <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
        <button id="btnRunCalc" type="button" disabled>
          Рассчитать / Определить координаты домов
        </button>
      </div>

      <div id="calc_out" style="margin-top:6px; color:#444;"></div>

      <div id="calc_preview_wrap" style="display:none; margin-top:10px;">
        <div style="font-size:12px;color:#555; margin-bottom:6px;">Превью результата</div>
        <img id="calc_preview" alt="calc preview"
             style="max-width:100%; border:1px solid #e5e7eb; border-radius:8px; display:block;">
        <div id="calc_preview_thumbs"
             style="display:grid; grid-template-columns:repeat(auto-fill,minmax(120px,1fr)); gap:8px; margin-top:8px;"></div>
      </div>
    </div>

    <!-- Экспорт -->
    <div class="card" id="cardExport" style="min-width:420px; display:none;">
      <h3>Выгрузка в Excel</h3>

      <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px;">
        <button id="btnExportSelectAll" type="button">Выбрать всё</button>
        <button id="btnExportClear" type="button">Снять всё</button>
        <label style="margin-left:auto;">
          <input id="export_only_houses" type="checkbox" checked>
          Только label = <b>house</b>
        </label>
      </div>

      <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap:10px; margin-bottom:12px;">
        <fieldset style="border:1px solid #eee; border-radius:8px; padding:8px;">
          <legend style="padding:0 6px;">Фото</legend>
          <label><input type="checkbox" name="export_field" value="photo_id"> photo_id</label><br/>
          <label><input type="checkbox" name="export_field" value="photo_name" checked> photo_name</label><br/>
          <label><input type="checkbox" name="export_field" value="uuid"> uuid</label><br/>
          <label><input type="checkbox" name="export_field" value="created"> created</label><br/>
          <label><input type="checkbox" name="export_field" value="width"> width</label> ·
          <label><input type="checkbox" name="export_field" value="height"> height</label><br/>
          <label><input type="checkbox" name="export_field" value="type"> type</label> ·
          <label><input type="checkbox" name="export_field" value="subtype"> subtype</label><br/>
          <label><input type="checkbox" name="export_field" value="shot_lat"> shot_lat</label> ·
          <label><input type="checkbox" name="export_field" value="shot_lon"> shot_lon</label>
        </fieldset>

        <fieldset style="border:1px solid #eee; border-radius:8px; padding:8px;">
          <legend style="padding:0 6px;">Объект (дом)</legend>
          <label><input type="checkbox" name="export_field" value="object_id"> object_id</label><br/>
          <label><input type="checkbox" name="export_field" value="label" checked> label</label> ·
          <label><input type="checkbox" name="export_field" value="confidence" checked> confidence</label><br/>
          <div style="margin:6px 0 4px; font-size:12px; color:#555;">bbox:</div>
          <label><input type="checkbox" name="export_field" value="x1" checked> x1</label>
          <label><input type="checkbox" name="export_field" value="y1" checked> y1</label>
          <label><input type="checkbox" name="export_field" value="x2" checked> x2</label>
          <label><input type="checkbox" name="export_field" value="y2" checked> y2</label><br/>
          <label><input type="checkbox" name="export_field" value="latitude" checked> latitude</label> ·
          <label><input type="checkbox" name="export_field" value="longitude" checked> longitude</label><br/>
          <label><input type="checkbox" name="export_field" value="object_created"> object_created</label>
        </fieldset>
      </div>

      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button id="btnExportXlsx" type="button">Экспортировать в Excel</button>
        <div id="export_status" style="color:#444;"></div>
      </div>
    </div>
  </div>

  <script src="/app.js"></script>
</body>
</html>
